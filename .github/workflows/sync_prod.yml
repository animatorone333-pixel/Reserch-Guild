name: Sync Supabase + Deploy Vercel

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      chat_policy:
        description: "Chat RLS policy: A=public insert, B=auth only"
        required: true
        default: "A"

concurrency:
  group: sync-prod-${{ github.ref }}
  cancel-in-progress: true

jobs:
  supabase-sync:
    name: Apply Supabase SQL
    runs-on: ubuntu-latest
    if: ${{ secrets.SUPABASE_DATABASE_URL != '' }}
    env:
      DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
      CHAT_POLICY: ${{ github.event.inputs.chat_policy || secrets.SUPABASE_CHAT_POLICY || 'A' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply schema + RLS (idempotent)
        run: |
          set -e
          echo "Applying DB migrations to Supabaseâ€¦"

          # Chat
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/create_messages_table.sql
          if [ "${CHAT_POLICY}" = "B" ]; then
            echo "Applying chat policy B (auth-only insert)"
            psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/rls_allow_auth.sql
          else
            echo "Applying chat policy A (public insert)"
            psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/rls_allow_public.sql
          fi

          # Register
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/setup_registrations_complete.sql

          # Shop
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/create_shop_items_table.sql
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/rls_shop_items.sql

          # Announcements
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/create_announcements_table.sql
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f db/rls_announcements.sql

      - name: Quick sanity checks
        run: |
          set -e
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -c "\dt public.messages" || true
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -c "\dt public.registrations" || true
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -c "\dt public.shop_items" || true
          psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -c "\dt public.announcements" || true

  vercel-deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [ supabase-sync ]
    if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Vercel Deploy
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
